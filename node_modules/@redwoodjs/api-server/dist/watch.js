#!/usr/bin/env node
"use strict";

var _child_process = require("child_process");

var _path = _interopRequireDefault(require("path"));

var _ansiColors = _interopRequireDefault(require("ansi-colors"));

var _chokidar = _interopRequireDefault(require("chokidar"));

var _dotenv = _interopRequireDefault(require("dotenv"));

var _lodash = require("lodash");

var _internal = require("@redwoodjs/internal");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const rwjsPaths = (0, _internal.getPaths)();

_dotenv.default.config({
  path: rwjsPaths.base
}); // TODO:
// 1. Move this file out of the HTTP server, and place it in the CLI?


let httpServerProcess;

const rebuildApiServer = () => {
  try {
    var _httpServerProcess, _httpServerProcess2;

    // Shutdown API server
    (_httpServerProcess = httpServerProcess) === null || _httpServerProcess === void 0 ? void 0 : _httpServerProcess.emit('exit');
    (_httpServerProcess2 = httpServerProcess) === null || _httpServerProcess2 === void 0 ? void 0 : _httpServerProcess2.kill();
    const buildTs = Date.now();
    process.stdout.write(_ansiColors.default.dim(_ansiColors.default.italic('Building... ')));
    (0, _internal.buildApi)();
    console.log(_ansiColors.default.dim(_ansiColors.default.italic('Took ' + (Date.now() - buildTs) + ' ms'))); // Start API server

    httpServerProcess = (0, _child_process.fork)(_path.default.join(__dirname, 'index.js'), ['--port', (0, _internal.getConfig)().api.port.toString()]);
  } catch (e) {
    console.error(e);
  }
}; // We want to delay exection when multiple files are modified on the filesystem,
// this usually happens when running RedwoodJS generator commands.
// Local writes are very fast, but writes in e2e environments are not,
// so allow the default to be adjust with a env-var.


const delayRestartServer = (0, _lodash.debounce)(rebuildApiServer, process.env.RWJS_DELAY_RESTART ? parseInt(process.env.RWJS_DELAY_RESTART, 10) : 5); // NOTE: the file comes through as a unix path, even on windows
// So we need to convert the rwjsPaths

const IGNORED_API_PATHS = ['api/dist', // use this, because using rwjsPaths.api.dist seems to not ignore on first build
rwjsPaths.api.types, rwjsPaths.api.db].map(path => (0, _internal.ensurePosixPath)(path));

_chokidar.default.watch(rwjsPaths.api.base, {
  persistent: true,
  ignoreInitial: true,
  ignored: file => {
    const x = file.includes('node_modules') || IGNORED_API_PATHS.some(ignoredPath => file.includes(ignoredPath)) || ['.DS_Store', '.db', '.sqlite', '-journal', '.test.js', '.test.ts', '.scenarios.ts', '.scenarios.js', '.d.ts', '.log'].some(ext => file.endsWith(ext));
    return x;
  }
}).on('ready', async () => {
  rebuildApiServer();
}).on('all', (eventName, filePath) => {
  console.log(_ansiColors.default.dim(`[${eventName}] ${filePath.replace(rwjsPaths.api.base, '')}`));
  delayRestartServer.cancel();
  delayRestartServer();
});