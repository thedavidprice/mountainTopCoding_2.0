"use strict";

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js/object/define-property");

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault").default;

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.azureActiveDirectory = void 0;

var _promise = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/promise"));

var _jsonwebtoken = _interopRequireDefault(require("jsonwebtoken"));

var _jwksRsa = _interopRequireDefault(require("jwks-rsa"));

const verifyAzureActiveDirectoryToken = bearerToken => {
  return new _promise.default((resolve, reject) => {
    const {
      AZURE_ACTIVE_DIRECTORY_AUTHORITY
    } = process.env;

    if (!AZURE_ACTIVE_DIRECTORY_AUTHORITY) {
      throw new Error('`AZURE_ACTIVE_DIRECTORY_AUTHORITY` env var is not set.');
    }
    /** @docs: https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-protocols-oidc#sample-response */


    const client = (0, _jwksRsa.default)({
      jwksUri: `${AZURE_ACTIVE_DIRECTORY_AUTHORITY}/discovery/v2.0/keys`
    });

    _jsonwebtoken.default.verify(bearerToken, (header, callback) => {
      client.getSigningKey(header.kid, (error, key) => {
        try {
          callback(error, key.getPublicKey());
        } catch (err) {
          console.error('An error occurred while trying to obtain signing key from Azure Active Directory. This might be a result of an outage. See https://status.azure.com/en-us/status for current status.', err);
        }
      });
    }, {
      issuer: `${AZURE_ACTIVE_DIRECTORY_AUTHORITY}/v2.0`,
      algorithms: ['RS256']
    }, (verifyError, decoded) => {
      if (verifyError) {
        return reject(verifyError);
      }

      resolve(typeof decoded === 'undefined' ? null : decoded);
    });
  });
};

const azureActiveDirectory = async token => {
  return verifyAzureActiveDirectoryToken(token);
};

exports.azureActiveDirectory = azureActiveDirectory;