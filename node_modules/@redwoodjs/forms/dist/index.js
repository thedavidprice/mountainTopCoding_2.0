"use strict";

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js/object/define-property");

var _interopRequireWildcard = require("@babel/runtime-corejs3/helpers/interopRequireWildcard").default;

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault").default;

_Object$defineProperty(exports, "__esModule", {
  value: true
});

_Object$defineProperty(exports, "FormError", {
  enumerable: true,
  get: function () {
    return _FormError.default;
  }
});

exports.WeekField = exports.UrlField = exports.TimeField = exports.TextField = exports.TelField = exports.SubmitField = exports.SearchField = exports.ResetField = exports.RangeField = exports.RadioField = exports.PasswordField = exports.NumberField = exports.MonthField = exports.ImageField = exports.HiddenField = exports.FileField = exports.EmailField = exports.DatetimeLocalField = exports.DateField = exports.ColorField = exports.ButtonField = exports.Submit = exports.SelectField = exports.TextAreaField = exports.Label = exports.InputField = exports.FieldError = exports.FieldErrorContext = exports.Form = exports.CheckboxField = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime-corejs3/helpers/extends"));

var _forEach = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/for-each"));

var _keys = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/object/keys"));

var _react = _interopRequireWildcard(require("react"));

var _pascalcase = _interopRequireDefault(require("pascalcase"));

var _reactHookForm = require("react-hook-form");

var _coercion = require("./coercion");

var _FormError = _interopRequireDefault(require("./FormError"));

const DEFAULT_MESSAGES = {
  required: 'is required',
  pattern: 'is not formatted correctly',
  minLength: 'is too short',
  maxLength: 'is too long',
  min: 'is too low',
  max: 'is too high',
  validate: 'is not valid'
};
const INPUT_TYPES = ['button', 'color', 'date', 'datetime-local', 'email', 'file', 'hidden', 'image', 'month', 'number', 'password', 'radio', 'range', 'reset', 'search', 'submit', 'tel', 'text', 'time', 'url', 'week'];

const inputTagProps = props => {
  const {
    formState: {
      errors
    },
    setError // eslint-disable-next-line react-hooks/rules-of-hooks

  } = (0, _reactHookForm.useFormContext)(); // Check for errors from server and set on field if present
  // eslint-disable-next-line react-hooks/rules-of-hooks

  const fieldErrorsContext = (0, _react.useContext)(FieldErrorContext);
  const contextError = fieldErrorsContext[props.name]; // eslint-disable-next-line react-hooks/rules-of-hooks

  _react.default.useEffect(() => {
    if (contextError) {
      setError(props.name, {
        type: 'server',
        message: contextError
      });
    }
  }, [contextError, props.name, setError]); // any errors on this field


  const validationError = props.name ? (0, _reactHookForm.get)(errors, props.name) : undefined; // get errorStyle/errorClassName and replace style/className if present
  // Also remove transformValue from tagProps

  const {
    errorClassName,
    errorStyle,
    transformValue,
    // eslint-disable-line @typescript-eslint/no-unused-vars
    ...tagProps
  } = props;

  if (validationError) {
    if (errorClassName) {
      tagProps.className = errorClassName;
    }

    if (errorStyle) {
      tagProps.style = errorStyle;
    }
  }

  return tagProps;
}; // A hook-like function merge field props and return props (ref, onChange and onBlur primarily) of RHF v7 register()


const useFieldRegister = (props, ref) => {
  const {
    register
  } = (0, _reactHookForm.useFormContext)();
  const validation = props.validation || {
    required: false
  }; // Primarily for TextAreaField

  if (!validation.validate && props.transformValue === 'Json') {
    validation.validate = jsonValidation;
  }

  const tagProps = inputTagProps(props);
  const {
    ref: _ref,
    onBlur: handleBlur,
    onChange: handleChange,
    ...rest
  } = register(props.name, validation);

  const onBlur = event => {
    var _tagProps$onBlur;

    handleBlur(event);
    tagProps === null || tagProps === void 0 ? void 0 : (_tagProps$onBlur = tagProps.onBlur) === null || _tagProps$onBlur === void 0 ? void 0 : _tagProps$onBlur.call(tagProps, event);
  };

  const onChange = event => {
    var _tagProps$onChange;

    handleChange(event);
    tagProps === null || tagProps === void 0 ? void 0 : (_tagProps$onChange = tagProps.onChange) === null || _tagProps$onChange === void 0 ? void 0 : _tagProps$onChange.call(tagProps, event);
  };

  return { ...tagProps,
    ...rest,
    onBlur,
    onChange,
    ref: element => {
      _ref(element);

      if (typeof ref === 'function') {
        ref(element);
      } else if (ref) {
        ref.current = element;
      }
    }
  };
}; // Context for keeping track of errors from the server


const FieldErrorContext = /*#__PURE__*/_react.default.createContext({});

exports.FieldErrorContext = FieldErrorContext;

const coerceValues = (data, coerce) => {
  var _context;

  const coercedData = {};
  (0, _forEach.default)(_context = (0, _keys.default)(data)).call(_context, name => {
    coercedData[name] = coerce(name, data[name]);
  });
  return coercedData;
};

const FormWithCoercionContext = props => {
  var _errorProps$graphQLEr, _errorProps$graphQLEr2, _errorProps$graphQLEr3;

  // deconstruct some props we care about and keep the remaining `formProps` to
  // pass to the <form> tag
  const {
    error: errorProps,
    formMethods: propFormMethods,
    onSubmit,
    ...formProps
  } = props;
  const useFormReturn = (0, _reactHookForm.useForm)(props.validation);
  const formMethods = propFormMethods || useFormReturn;
  const {
    coerce
  } = (0, _coercion.useCoercion)();
  return /*#__PURE__*/_react.default.createElement("form", (0, _extends2.default)({}, formProps, {
    onSubmit: formMethods.handleSubmit((data, event) => onSubmit === null || onSubmit === void 0 ? void 0 : onSubmit(coerceValues(data, coerce), event))
  }), /*#__PURE__*/_react.default.createElement(FieldErrorContext.Provider, {
    value: (errorProps === null || errorProps === void 0 ? void 0 : (_errorProps$graphQLEr = errorProps.graphQLErrors[0]) === null || _errorProps$graphQLEr === void 0 ? void 0 : (_errorProps$graphQLEr2 = _errorProps$graphQLEr.extensions) === null || _errorProps$graphQLEr2 === void 0 ? void 0 : (_errorProps$graphQLEr3 = _errorProps$graphQLEr2.exception) === null || _errorProps$graphQLEr3 === void 0 ? void 0 : _errorProps$graphQLEr3.messages) || {}
  }, /*#__PURE__*/_react.default.createElement(_reactHookForm.FormProvider, formMethods, props.children)));
}; // Renders a containing <form> tag with required contexts


const Form = props => {
  return /*#__PURE__*/_react.default.createElement(_coercion.CoercionContextProvider, null, /*#__PURE__*/_react.default.createElement(FormWithCoercionContext, props));
}; // Renders a <label> tag that can be styled differently if errors are present
// on the related fields


exports.Form = Form;

const Label = props => {
  const tagProps = inputTagProps(props);
  return /*#__PURE__*/_react.default.createElement("label", (0, _extends2.default)({
    htmlFor: props.name
  }, tagProps), props.children || props.name);
}; // Renders a <span> with a validation error message if there is an error on this
// field


exports.Label = Label;

const FieldError = props => {
  const {
    formState: {
      errors
    }
  } = (0, _reactHookForm.useFormContext)();
  const validationError = (0, _reactHookForm.get)(errors, props.name);
  const errorMessage = validationError && (validationError.message || `${props.name} ${DEFAULT_MESSAGES[validationError.type]}`);
  return validationError ? /*#__PURE__*/_react.default.createElement("span", props, errorMessage) : null;
};

exports.FieldError = FieldError;

const jsonValidation = value => {
  try {
    JSON.parse(value);
  } catch (e) {
    return e.message;
  }
}; // Renders a <textarea> field


const TextAreaField = /*#__PURE__*/(0, _react.forwardRef)((props, ref) => {
  const fieldProps = useFieldRegister(props, ref);
  const {
    setCoercion
  } = (0, _coercion.useCoercion)();

  _react.default.useEffect(() => {
    setCoercion({
      name: props.name,
      transformValue: props.transformValue
    });
  }, [setCoercion, props.name, props.transformValue]);

  return /*#__PURE__*/_react.default.createElement("textarea", (0, _extends2.default)({
    id: props.id || props.name
  }, fieldProps));
}); // Renders a <select> field

exports.TextAreaField = TextAreaField;
const SelectField = /*#__PURE__*/(0, _react.forwardRef)((props, ref) => {
  const fieldProps = useFieldRegister(props, ref);
  const {
    setCoercion
  } = (0, _coercion.useCoercion)();

  _react.default.useEffect(() => {
    setCoercion({
      name: props.name,
      transformValue: props.transformValue
    });
  }, [setCoercion, props.name, props.transformValue]);

  return /*#__PURE__*/_react.default.createElement("select", (0, _extends2.default)({
    id: props.id || props.name
  }, fieldProps));
}); // Renders a <input type="checkbox"> field

exports.SelectField = SelectField;
const CheckboxField = /*#__PURE__*/(0, _react.forwardRef)((props, ref) => {
  const fieldProps = useFieldRegister(props, ref);
  const {
    setCoercion
  } = (0, _coercion.useCoercion)();
  const type = 'checkbox';

  _react.default.useEffect(() => {
    setCoercion({
      name: props.name,
      type,
      transformValue: props.transformValue
    });
  }, [setCoercion, props.name, type, props.transformValue]);

  return /*#__PURE__*/_react.default.createElement("input", (0, _extends2.default)({
    type: "checkbox",
    id: props.id || props.name
  }, fieldProps));
}); // Renders a <button type="submit">

exports.CheckboxField = CheckboxField;
const Submit = /*#__PURE__*/(0, _react.forwardRef)((props, ref) => /*#__PURE__*/_react.default.createElement("button", (0, _extends2.default)({
  ref: ref,
  type: "submit"
}, props))); // Renders a <input>

exports.Submit = Submit;
const InputField = /*#__PURE__*/(0, _react.forwardRef)((props, ref) => {
  const fieldProps = useFieldRegister(props, ref);
  const {
    setCoercion
  } = (0, _coercion.useCoercion)();

  _react.default.useEffect(() => {
    setCoercion({
      name: props.name,
      type: props.type,
      transformValue: props.transformValue
    });
  }, [setCoercion, props.name, props.type, props.transformValue]);

  return /*#__PURE__*/_react.default.createElement("input", (0, _extends2.default)({
    id: props.id || props.name
  }, fieldProps));
}); // Create a component for each type of Input.
//
// Uses a bit of Javascript metaprogramming to create the functions with a dynamic
// name rather than having to write out each and every component definition. In
// simple terms it creates an object with the key being the current value of `type`
// and then immediately returns the value, which is the component function definition.
//
// In the end we end up with `inputComponents.TextField` and all the others. Export those
// and we're good to go.

exports.InputField = InputField;
const inputComponents = {};
(0, _forEach.default)(INPUT_TYPES).call(INPUT_TYPES, type => {
  inputComponents[`${(0, _pascalcase.default)(type)}Field`] = /*#__PURE__*/(0, _react.forwardRef)((props, ref) => /*#__PURE__*/_react.default.createElement(InputField, (0, _extends2.default)({
    ref: ref,
    type: type
  }, props)));
});
const {
  ButtonField,
  ColorField,
  DateField,
  DatetimeLocalField,
  EmailField,
  FileField,
  HiddenField,
  ImageField,
  MonthField,
  NumberField,
  PasswordField,
  RadioField,
  RangeField,
  ResetField,
  SearchField,
  SubmitField,
  TelField,
  TextField,
  TimeField,
  UrlField,
  WeekField
} = inputComponents;
exports.WeekField = WeekField;
exports.UrlField = UrlField;
exports.TimeField = TimeField;
exports.TextField = TextField;
exports.TelField = TelField;
exports.SubmitField = SubmitField;
exports.SearchField = SearchField;
exports.ResetField = ResetField;
exports.RangeField = RangeField;
exports.RadioField = RadioField;
exports.PasswordField = PasswordField;
exports.NumberField = NumberField;
exports.MonthField = MonthField;
exports.ImageField = ImageField;
exports.HiddenField = HiddenField;
exports.FileField = FileField;
exports.EmailField = EmailField;
exports.DatetimeLocalField = DatetimeLocalField;
exports.DateField = DateField;
exports.ColorField = ColorField;
exports.ButtonField = ButtonField;