"use strict";

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js/object/define-property");

var _interopRequireWildcard = require("@babel/runtime-corejs3/helpers/interopRequireWildcard").default;

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault").default;

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.RedwoodApolloProvider = void 0;

var _react = _interopRequireDefault(require("react"));

var _concat = _interopRequireDefault(require("@babel/runtime-corejs3/core-js/instance/concat"));

var apolloClient = _interopRequireWildcard(require("@apollo/client"));

var _context = require("@apollo/client/link/context");

var _auth = require("@redwoodjs/auth");

require("./typeOverride");

var _FetchConfigProvider = require("../components/FetchConfigProvider");

var _GraphQLHooksProvider = require("../components/GraphQLHooksProvider");

// Note: Importing directly from `apollo/client` does not work properly in Storybook.
const {
  ApolloProvider,
  ApolloClient,
  ApolloLink,
  createHttpLink,
  InMemoryCache,
  useQuery,
  useMutation
} = apolloClient;

const ApolloProviderWithFetchConfig = ({
  config = {},
  children,
  useAuth
}) => {
  const {
    uri,
    headers
  } = (0, _FetchConfigProvider.useFetchConfig)();
  const {
    getToken,
    type: authProviderType,
    isAuthenticated
  } = useAuth();
  const withToken = (0, _context.setContext)(async () => {
    if (isAuthenticated && getToken) {
      const token = await getToken();
      return {
        token
      };
    }

    return {
      token: null
    };
  });
  const authMiddleware = new ApolloLink((operation, forward) => {
    const {
      token
    } = operation.getContext(); // Only add auth headers when token is present
    // Token is null, when !isAuthenticated

    const authHeaders = token ? {
      'auth-provider': authProviderType,
      authorization: `Bearer ${token}`
    } : {};
    operation.setContext(() => ({
      headers: { ...headers,
        // Duped auth headers, because we may remove FetchContext at a later date
        ...authHeaders
      }
    }));
    return forward(operation);
  });
  const httpLink = createHttpLink({
    uri
  });
  const client = new ApolloClient({
    cache: new InMemoryCache(),
    ...config,
    link: ApolloLink.from([withToken, (0, _concat.default)(authMiddleware).call(authMiddleware, httpLink)])
  });
  return /*#__PURE__*/_react.default.createElement(ApolloProvider, {
    client: client
  }, children);
};

const RedwoodApolloProvider = ({
  graphQLClientConfig,
  useAuth = _auth.useAuth,
  children
}) => {
  return /*#__PURE__*/_react.default.createElement(_FetchConfigProvider.FetchConfigProvider, {
    useAuth: useAuth
  }, /*#__PURE__*/_react.default.createElement(ApolloProviderWithFetchConfig, {
    config: graphQLClientConfig,
    useAuth: useAuth
  }, /*#__PURE__*/_react.default.createElement(_GraphQLHooksProvider.GraphQLHooksProvider, {
    useQuery: useQuery,
    useMutation: useMutation
  }, children)));
};

exports.RedwoodApolloProvider = RedwoodApolloProvider;